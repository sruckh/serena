# CLAUDE.md
<!-- Generated by Claude Conductor v1.1.2 -->

> _Read me first. Every other doc is linked below._

## Critical Context (Read First)
- **Tech Stack**: Python 3.11, LSP servers, MCP protocol, Flask dashboard, Docker
- **Main File**: `src/serena/agent.py` (800+ lines) - Central orchestrator and MCP server
- **Core Mechanic**: AI coding assistant with language-aware symbol manipulation via LSP
- **Key Integration**: Model Context Protocol (MCP) for AI agent communication
- **Platform Support**: Cross-platform Python package with Docker deployment
- **DO NOT**: Create files without LSP integration, modify language server binaries, skip type checking

## Table of Contents
1. [Architecture](ARCHITECTURE.md) - Tech stack, folder structure, infrastructure
2. [Design Tokens](DESIGN.md) - Colors, typography, visual system  
3. [UI/UX Patterns](UIUX.md) - Components, interactions, accessibility
4. [Runtime Config](CONFIG.md) - Environment variables, feature flags
5. [Data Model](DATA_MODEL.md) - Database schema, entities, relationships
6. [API Contracts](API.md) - Endpoints, request/response formats, auth
7. [Build & Release](BUILD.md) - Build process, deployment, CI/CD
8. [Testing Guide](TEST.md) - Test strategies, E2E scenarios, coverage
9. [Operational Playbooks](PLAYBOOKS/DEPLOY.md) - Deployment, rollback, monitoring
10. [Contributing](CONTRIBUTING.md) - Code style, PR process, conventions
11. [Error Ledger](ERRORS.md) - Critical P0/P1 error tracking
12. [Task Management](TASKS.md) - Active tasks, phase tracking, context preservation

## Quick Reference
**SerenaAgent**: `src/serena/agent.py:94-400` - Main orchestrator class with MCP server  
**SolidLanguageServer**: `src/solidlsp/ls.py:100-300` - LSP wrapper for multi-language support  
**Tool Registry**: `src/serena/tools/__init__.py:20-50` - Tool discovery and registration  
**Config System**: `src/serena/config/serena_config.py:50-150` - Hierarchical configuration  
**Project Manager**: `src/serena/project.py:30-100` - Project activation and management  
**Memory System**: `src/serena/agent.py:61-93` - Persistent knowledge storage  
**Symbol Tools**: `src/serena/tools/symbol_tools.py:50-200` - Language-aware code editing  
**File Tools**: `src/serena/tools/file_tools.py:30-150` - File system operations  
**Language Server Factory**: `src/solidlsp/ls.py:200-400` - Language server instantiation  
**MCP Server**: `src/serena/mcp.py:20-100` - Model Context Protocol implementation  
**Dashboard API**: `src/serena/dashboard.py:30-80` - Web dashboard backend  
**CLI Interface**: `src/serena/cli.py:20-60` - Command-line entry points  
**Prompt Factory**: `src/serena/prompt_factory.py:20-80` - AI prompt generation  
**Analytics**: `src/serena/analytics.py:20-60` - Usage tracking and token estimation  
**Configuration Contexts**: `src/serena/resources/config/contexts/` - Tool environment configs

## Current State
- [x] Multi-language LSP integration (13+ languages)
- [x] MCP server implementation
- [x] Symbol-based code editing
- [x] Project memory system
- [x] Web dashboard interface
- [x] Docker deployment support
- [ ] Enhanced error recovery
- [ ] Performance optimizations
- [ ] Extended language support

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

**Essential Commands (use these exact commands):**
- `uv run poe format` - Format code (BLACK + RUFF) - ONLY allowed formatting command
- `uv run poe type-check` - Run mypy type checking - ONLY allowed type checking command  
- `uv run poe test` - Run tests with default markers (excludes java/rust by default)
- `uv run poe test -m "python or go"` - Run specific language tests
- `uv run poe lint` - Check code style without fixing

**Test Markers:**
Available pytest markers for selective testing:
- `python`, `go`, `java`, `rust`, `typescript`, `php`, `csharp`, `elixir`, `terraform`, `clojure`
- `snapshot` - for symbolic editing operation tests

**Project Management:**
- `uv run serena-mcp-server` - Start MCP server from project root
- `uv run index-project` - Index project for faster tool performance

**Always run format, type-check, and test before completing any task.**

## Architecture Overview

Serena is a dual-layer coding agent toolkit:

### Core Components

**1. SerenaAgent (`src/serena/agent.py`)**
- Central orchestrator managing projects, tools, and user interactions
- Coordinates language servers, memory persistence, and MCP server interface
- Manages tool registry and context/mode configurations

**2. SolidLanguageServer (`src/solidlsp/ls.py`)**  
- Unified wrapper around Language Server Protocol (LSP) implementations
- Provides language-agnostic interface for symbol operations
- Handles caching, error recovery, and multiple language server lifecycle

**3. Tool System (`src/serena/tools/`)**
- **file_tools.py** - File system operations, search, regex replacements
- **symbol_tools.py** - Language-aware symbol finding, navigation, editing
- **memory_tools.py** - Project knowledge persistence and retrieval
- **config_tools.py** - Project activation, mode switching
- **workflow_tools.py** - Onboarding and meta-operations

**4. Configuration System (`src/serena/config/`)**
- **Contexts** - Define tool sets for different environments (desktop-app, agent, ide-assistant)
- **Modes** - Operational patterns (planning, editing, interactive, one-shot)
- **Projects** - Per-project settings and language server configs

### Language Support Architecture

Each supported language has:
1. **Language Server Implementation** in `src/solidlsp/language_servers/`
2. **Runtime Dependencies** - Automatic language server downloads when needed
3. **Test Repository** in `test/resources/repos/<language>/`
4. **Test Suite** in `test/solidlsp/<language>/`

### Memory & Knowledge System

- **Markdown-based storage** in `.serena/memories/` directories
- **Project-specific knowledge** persistence across sessions
- **Contextual retrieval** based on relevance
- **Onboarding support** for new projects

## Development Patterns

### Adding New Languages
1. Create language server class in `src/solidlsp/language_servers/`
2. Add to Language enum in `src/solidlsp/ls_config.py` 
3. Update factory method in `src/solidlsp/ls.py`
4. Create test repository in `test/resources/repos/<language>/`
5. Write test suite in `test/solidlsp/<language>/`
6. Add pytest marker to `pyproject.toml`

### Adding New Tools
1. Inherit from `Tool` base class in `src/serena/tools/tools_base.py`
2. Implement required methods and parameter validation
3. Register in appropriate tool registry
4. Add to context/mode configurations

### Testing Strategy
- Language-specific tests use pytest markers
- Symbolic editing operations have snapshot tests
- Integration tests in `test_serena_agent.py`
- Test repositories provide realistic symbol structures

## Configuration Hierarchy

Configuration is loaded from (in order of precedence):
1. Command-line arguments to `serena-mcp-server`
2. Project-specific `.serena/project.yml`
3. User config `~/.serena/serena_config.yml`
4. Active modes and contexts

## Key Implementation Notes

- **Symbol-based editing** - Uses LSP for precise code manipulation
- **Caching strategy** - Reduces language server overhead
- **Error recovery** - Automatic language server restart on crashes
- **Multi-language support** - 13+ languages with LSP integration
- **MCP protocol** - Exposes tools to AI agents via Model Context Protocol
- **Async operation** - Non-blocking language server interactions

## Development Workflow
1. **Setup Environment**: `uv sync --dev` - Install dependencies
2. **Run Formatting**: `uv run poe format` - Format with BLACK + RUFF  
3. **Type Check**: `uv run poe type-check` - Run mypy validation
4. **Run Tests**: `uv run poe test` - Execute test suite
5. **Start MCP Server**: `uv run serena-mcp-server` - Launch for AI agents
6. **Deploy**: `docker build -t serena .` - Create production image

## Task Templates
### 1. Add New Language Support
1. Create language server class in `src/solidlsp/language_servers/new_lang.py:1-100`
2. Add Language enum entry in `src/solidlsp/ls_config.py:15-30`
3. Update factory method in `src/solidlsp/ls.py:200-250`
4. Create test repo in `test/resources/repos/new_lang/test_repo/`
5. Write test suite in `test/solidlsp/new_lang/test_new_lang_basic.py`
6. Add pytest marker to `pyproject.toml:251-262`

### 2. Add New Tool
1. Create tool class inheriting from `Tool` in `src/serena/tools/new_tool.py:1-50`
2. Implement `_call` method with proper parameter validation
3. Register in `src/serena/tools/__init__.py:20-50`
4. Add to context configs in `src/serena/resources/config/contexts/*.yml`
5. Write tests in `test/serena/test_new_tool.py`

### 3. Debug Language Server Issues
1. Check logs in `~/.serena/logs/solidlsp.log`
2. Verify server installation in `~/.serena/language_servers/`
3. Test LSP communication in `src/solidlsp/ls_handler.py:100-200`
4. Validate configuration in `src/solidlsp/language_servers/[lang]_server.py`

### 4. Update MCP Protocol Support
1. Modify server implementation in `src/serena/mcp.py:20-100`
2. Update tool registration in `src/serena/agent.py:200-300`
3. Test protocol compliance with MCP client
4. Update documentation in `API.md`

## Anti-Patterns (Avoid These)
❌ **Don't modify language server binaries** - Use configuration and wrappers instead  
❌ **Don't skip type checking** - All code must pass mypy validation  
❌ **Don't hardcode file paths** - Use `pathlib.Path` and project-relative paths  
❌ **Don't ignore LSP errors** - Handle language server failures gracefully  
❌ **Don't mix sync/async code** - Use proper async patterns for language servers  
❌ **Don't bypass project validation** - Always validate project roots and paths

## Version History
- **v0.1.3** - Current version with enhanced MCP support
- **v0.1.2** - Multi-language LSP integration (see JOURNAL.md 2024-01-15)
- **v0.1.1** - Initial tool system implementation
- **v0.1.0** - Initial release with basic agent functionality

## Working with the Codebase

- Project uses Python 3.11 with `uv` for dependency management
- Strict typing with mypy, formatted with black + ruff
- Language servers run as separate processes with LSP communication
- Memory system enables persistent project knowledge
- Context/mode system allows workflow customization

## Continuous Engineering Journal <!-- do not remove -->

Claude, keep an ever-growing changelog in [`JOURNAL.md`](JOURNAL.md).

### What to Journal
- **Major changes**: New features, significant refactors, API changes
- **Bug fixes**: What broke, why, and how it was fixed
- **Frustration points**: Problems that took multiple attempts to solve
- **Design decisions**: Why we chose one approach over another
- **Performance improvements**: Before/after metrics
- **User feedback**: Notable issues or requests
- **Learning moments**: New techniques or patterns discovered

### Journal Format
```
## YYYY-MM-DD HH:MM

### [Short Title]
- **What**: Brief description of the change
- **Why**: Reason for the change
- **How**: Technical approach taken
- **Issues**: Any problems encountered
- **Result**: Outcome and any metrics

### [Short Title] |ERROR:ERR-YYYY-MM-DD-001|
- **What**: Critical P0/P1 error description
- **Why**: Root cause analysis
- **How**: Fix implementation
- **Issues**: Debugging challenges
- **Result**: Resolution and prevention measures

### [Task Title] |TASK:TASK-YYYY-MM-DD-001|
- **What**: Task implementation summary
- **Why**: Part of [Phase Name] phase
- **How**: Technical approach and key decisions
- **Issues**: Blockers encountered and resolved
- **Result**: Task completed, findings documented in ARCHITECTURE.md
```

### Compaction Rule
When `JOURNAL.md` exceeds **500 lines**:
1. Claude summarizes the oldest half into `JOURNAL_ARCHIVE/<year>-<month>.md`
2. Remaining entries stay in `JOURNAL.md` so the file never grows unbounded

> ⚠️ Claude must NEVER delete raw history—only move & summarize.